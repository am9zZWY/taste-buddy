<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Editor</title>
</head>

<body>
    <h1>
        JOGJED - JOsef's Great Json-Editor
    </h1>
    <div id="editor">
    </div>
</body>
<script>
    const createStub = (items) => {
        const stub = {}
        items.forEach((item) => {
            Object.keys(item).forEach((key) => {
                if (!(key in stub)) {
                    const value = item[key]
                    if (typeof value === 'string') {
                        stub[key] = ''
                    } else if (typeof value === 'number') {
                        stub[key] = 0
                    } else if (typeof value === 'boolean') {
                        stub[key] = false
                    } else if (typeof value === 'object') {
                        if (Array.isArray(value)) {
                            stub[key] = [createStub(value)]
                        } else {
                            stub[key] = createStub(value)
                        }
                    }
                }
            })
        })
        console.debug(stub);
        return stub
    }

    const addElementButton = (item, appendOn) => {
        const buttonLi = document.createElement('li')
        const button = document.createElement('button')
        button.innerText = '+'
        button.onclick = () => {
            const li = document.createElement('li')
            const newElement = createElement(createStub(item))
            li.append(newElement)
            appendOn.insertBefore(li, buttonLi)
        }
        buttonLi.append(button)
        return buttonLi
    }

    const listItem = (item) => {
        const ul = document.createElement('ul')
        Object.keys(item).forEach((key) => {
            if (key !== 'id') {
                const value = item[key];
                const li = document.createElement('li');
                const span = document.createElement('span');
                span.append(key + ": ")

                if (Array.isArray(value)) {
                    /* 
                    if e.g. "faz" is an array:
                        "foo": "bar",
                        "faz": [
                            ...
                        ]
                    */
                    li.append(span, list(value))
                } else {
                    /* 
                    if e.g. "foo" is an a simple value:
                        "foo": "bar",
                    */
                    const input = document.createElement('input');
                    input.name = `item${key}`;
                    input.value = value;
                    li.append(span, input)
                }
                ul.appendChild(li)
            }
        })
        return ul
    }

    const list = (items) => {
        const ol = document.createElement('ol')
        items.forEach((item, index) => {
            const li = document.createElement('li');
            li.append(listItem(item))
            ol.appendChild(li)
        })
        ol.appendChild(addElementButton(items, ol))
        return ol
    }

    const createElement = (item) => {
        if (Array.isArray(item)) {
            return list(item)
        }
        return listItem(item)
    }

    const build = (name) => {
        fetch(`/m/${name}`)
            .then(response => response.json())
            .then(items => {
                const div = document.createElement('div');
                const h2 = document.createElement('h2');
                h2.innerHTML = name.toUpperCase();
                div.appendChild(h2);
                div.appendChild(createElement(items));
                document.getElementById('editor').appendChild(div);
            });
    }

    ['item', 'recipe'].forEach(build);
</script>

</html>